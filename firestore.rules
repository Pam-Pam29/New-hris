rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is HR or Admin
    // Simplified for development - checks if hrUsers document exists
    function isHROrAdmin() {
      return isAuthenticated();
    }
    
    // Helper function to check if user owns the resource
    function isOwner(employeeId) {
      return isAuthenticated() && 
        (request.auth.uid == employeeId || 
         request.auth.token.email == get(/databases/$(database)/documents/employeeProfiles/$(employeeId)).data.auth.email);
    }
    
    // Simplified owner check by email (for employee access)
    function isEmployeeOwner(employeeId) {
      return isAuthenticated(); // Simplified for development - app handles email matching
    }
    
    // Helper function for company isolation (simplified for development)
    function belongsToCompany(companyId) {
      return isAuthenticated(); // Simplified - app-level logic handles isolation
    }
    
    // ==========================================
    // HR USERS - HR can read own profile
    // ==========================================
    match /hrUsers/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated();
    }
    
    // ==========================================
    // COMPANIES - Read by all, write by admin only
    // ==========================================
    match /companies/{companyId} {
      allow read: if true; // Public read for company info
      allow create: if isAuthenticated(); // Allow authenticated users to create companies during onboarding
      allow update, delete: if isHROrAdmin();
    }

    // ==========================================
    // CONTRACTS - HR can create/read, employees can read own
    // ==========================================
    match /contracts/{contractId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
      allow create: if isHROrAdmin();
    }
    
    // ==========================================
    // EMPLOYEES - HR can manage, employees can read own
    // ==========================================
    match /employees/{employeeId} {
      allow read: if true; // Allow unauthenticated read for login queries
      allow update: if true; // Allow updates for setup process
      allow create, delete: if isHROrAdmin();
    }
    
    match /employeeProfiles/{employeeId} {
      allow read: if isAuthenticated(); // All authenticated users can read
      allow update: if true; // Allow updates for setup process
      allow create, delete: if isHROrAdmin();
    }
    
    // ==========================================
    // ONBOARDING - Employee and HR access
    // ==========================================
    match /onboarding/{employeeId} {
      allow read: if isAuthenticated() && 
        (isOwner(employeeId) || isHROrAdmin());
      allow write: if isAuthenticated() && 
        (isOwner(employeeId) || isHROrAdmin());
    }
    
    // ==========================================
    // LEAVE MANAGEMENT - Secure but functional
    // ==========================================
    match /leaveTypes/{typeId} {
      allow read: if true; // All can read leave types
      allow write: if isHROrAdmin();
    }
    
    match /leaveBalances/{balanceId} {
      allow read: if isAuthenticated(); // Simplified for development
      allow write: if isHROrAdmin();
    }
    
    match /leaveRequests/{requestId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isHROrAdmin(); // Only HR can approve/reject
      allow delete: if isHROrAdmin();
    }
    
    // ==========================================
    // RECRUITMENT - Public read, HR write
    // ==========================================
    match /jobPostings/{jobId} {
      allow read: if true; // Public job board
      allow write: if isHROrAdmin();
    }
    
    match /jobs/{jobId} {
      allow read: if true; // Public job board (alternate collection name)
      allow write: if isHROrAdmin();
    }
    
    match /jobPosts/{jobId} {
      allow read: if true; // Public job board (alternate collection name)
      allow write: if isHROrAdmin();
    }
    
    match /job_postings/{jobId} {
      allow read: if true; // Public job board (with underscore)
      allow write: if isHROrAdmin();
    }
    
    match /candidates/{candidateId} {
      allow create: if true; // Public can apply
      allow read: if isHROrAdmin(); // Only HR can see candidates
      allow update, delete: if isHROrAdmin();
    }
    
    match /interviews/{interviewId} {
      allow read: if isAuthenticated(); // Allow all authenticated users to read
      allow write: if isHROrAdmin();
    }
    
    match /applications/{applicationId} {
      allow create: if true; // Public can apply
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.applicantId || isHROrAdmin());
      allow update, delete: if isHROrAdmin();
    }
    
    // ==========================================
    // PAYROLL - Highly sensitive, HR only write
    // ==========================================
    match /payroll_records/{recordId} {
      allow read: if isAuthenticated(); // Simplified for development
      allow write: if isHROrAdmin();
    }
    
    match /financial_requests/{requestId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isHROrAdmin();
      allow delete: if isHROrAdmin();
    }
    
    // ==========================================
    // PERFORMANCE MANAGEMENT
    // ==========================================
    match /performanceGoals/{goalId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isHROrAdmin();
    }
    
    match /performanceReviews/{reviewId} {
      allow create: if isHROrAdmin();
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isHROrAdmin();
    }
    
    match /performanceMeetings/{meetingId} {
      allow read, write: if isAuthenticated();
    }
    
    // ==========================================
    // POLICIES
    // ==========================================
    match /policies/{policyId} {
      allow read: if isAuthenticated(); // All employees can read
      allow write: if isHROrAdmin();
    }
    
    match /policyAcknowledgments/{ackId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isHROrAdmin();
    }
    
    // ==========================================
    // ASSETS - FIXED COLLECTION NAMES
    // ==========================================
    match /assets/{assetId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    // Fixed: asset_assignments (underscore, not camelCase)
    match /asset_assignments/{assignmentId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    // Fixed: maintenance_records (underscore, not camelCase)
    match /maintenance_records/{recordId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    match /assetRequests/{requestId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isHROrAdmin();
    }
    
    // Added: Missing starterKits collection
    match /starterKits/{kitId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    // ==========================================
    // TIME TRACKING
    // ==========================================
    match /timeEntries/{entryId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isHROrAdmin();
    }
    
    match /timeTracking/{document=**} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isHROrAdmin();
    }
    
    match /timeAdjustmentRequests/{requestId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isHROrAdmin();
      allow delete: if isHROrAdmin();
    }
    
    match /attendance/{document=**} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isHROrAdmin();
    }
    
    // ==========================================
    // SCHEDULES & MEETINGS
    // ==========================================
    match /schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    match /workSchedules/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    match /shiftTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    match /meetingSchedules/{meetingId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
    
    // ==========================================
    // NOTIFICATIONS
    // ==========================================
    match /notifications/{notificationId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    match /timeNotifications/{notifId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isHROrAdmin();
    }
    
    // ==========================================
    // ACTIVITY LOGS - Admin only
    // ==========================================
    match /activityLogs/{logId} {
      allow read, write: if isHROrAdmin();
    }
    
    // ==========================================
    // HR SPECIFIC
    // ==========================================
    match /hrAvailability/{slotId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    match /hrSettings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    match /employeeDashboardData/{employeeId} {
      allow read: if isAuthenticated();
      allow write: if isHROrAdmin();
    }
    
    // ==========================================
    // DEPARTMENTS - Read all, write HR only
    // ==========================================
    match /departments/{deptId} {
      allow read: if true;
      allow write: if isHROrAdmin();
    }
    
    // ==========================================
    // DOCUMENT METADATA - For Cloudinary integration
    // ==========================================
    match /documentMetadata/{docId} {
      allow read, write: if true;
    }
  }
}